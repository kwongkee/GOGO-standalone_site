{include file="common/merchant_header"}
<style type="text/css">
    .layui-upload-img{width: 92px; height: 92px; margin: 0 10px 10px 0;}
    .layui-btn{background-color: #F7931E !important;}
    .layui-btn-primary{background-color: #fff !important;}
    .layui-btn-primary:hover {border-color: #F7931E !important;}
    .layui-fluid{padding:0;}
    .info_div{display: grid;grid-template-columns: repeat(2,1fr);-moz-column-gap: 0px;column-gap: 0px;row-gap: 0px;}
    .layui-table th{background: {$website['color']};color:{$website['color_word']};}
    .layui-colla-content{padding:10px;}
    .type2{display:none;}
    @media screen and (min-width: 992px){
        .layui-form-label {margin-left: 0px!important;}
        .layui-input-block{margin-left: 140px !important;}
        .yulan{width: 700px !important;}
        .layui-select-fs{width: 100%;}
        .layui-select-fscon{width: 735px !important;}
    }
    @media screen and (max-width: 450px){
        .layui-form-label {width: 75px!important;margin-left: 0px!important;}
        .layui-input-block{margin-left: 100px !important;}
        .layui-form-label{padding: 9px 5px;}
        .yulan{width: 72% !important;}
        .layui-select-fs{width: 100%;}
        .layui-select-fscon{width: 62%  !important;}
        .layui-form-item .layui-input-inline {display: block;float: none;left: 4px;width: auto;margin: 0 0 10px 95px;}
        .layui-form-item .layui-inline {margin-bottom:10px;}
        .layui-form-item{margin-bottom:0 !important;}
        .info_div{display: grid;grid-template-columns: repeat(1,1fr);-moz-column-gap: 0px;column-gap: 0px;row-gap: 0px;}
    }
    html{background:#fff;}
    .layui-btn{background:{$website['color']} !important;}
    .layui-btn-danger{background:#e60000 !important;}
    .layui-btn-primary{background:#fff !important;}
    .sel_box{width: 50%;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}
    .sel_div .layui-form-selected dl{width: 100%;}
    .result_div{display:none;width: calc(100% - 0px);height: 200px;position: absolute;background: #fff;color: #000;font-size: 13px;overflow-y: scroll;z-index: 9;border: 1px solid #c7c6c6;padding: 5px 10px;box-sizing: border-box;}
    .result_div li{border-bottom:1px solid #000;padding:5px 0;box-sizing: border-box;}
    .result_div li:hover{background:{$website['color']};color:{$website['color_word']};cursor:pointer;}
    .layui-colla-title{background:{$website['color']};color:{$website['color_word']};}
    .member_opera{border:1px solid {$website['color_word']};}
    {if $id>0}
    .layui-fluid{margin-top:10px;}
    {/if}
</style>
<script src="/centralize_manager/js/jquery.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script src="/layuiadmin/qrcode/jquery-3.2.1.min.js"></script>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body" style="padding: 10px;">
            <form class="layui-form" action="" lay-filter="component-form-group">
                <input type="hidden" name="id" value="{$id}">
                <input type="hidden" name="pa" value="1">

                <div class="layui-form-item">
                    <label class="layui-form-label">群组名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="name" id="name" lay-verify="required" placeholder="群组名称" autocomplete="off" class="layui-input" value="{$data['name']}">
                    </div>
                </div>

                <div class="layui-collapse" lay-accordion="now" style="margin:10px 0;">
                    <div class="layui-colla-item">
                        <h2 class="layui-colla-title"><div class="disf" style="justify-content: space-between;"><div class="sel_box"><span class="sel">请选择组员</span></div><div><div class="layui-btn layui-btn-parimary member_opera" onclick="add_member(this)">+</div></div></div></h2>
                        <div class="layui-colla-content layui-show">
                            <div class="info_div">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">邀请方式</label>
                                    <div class="layui-input-block">
                                        <select name="type[]" lay-filter="type">
                                            <option value="1">搜索组员“邮箱”或“手机号”</option>
                                            <option value="2">填写组员“邮箱”</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-form-item type1">
                                    <label class="layui-form-label">选择组员</label>
                                    <div class="layui-input-block">
                                        <input type="hidden" name="user_id[]" class="user_id" value="">
                                        <input type="text" name="user_name[]" lay-verify="" placeholder="搜索组员“邮箱”或“手机号”" id="user_id" autocomplete="off" class="layui-input user_name" value="" oninput="search_user(this)">
                                        <div class="result_div"></div>
                                    </div>
                                </div>
                                <div class="layui-form-item type2">
                                    <label class="layui-form-label">填写邮箱</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="email[]" lay-verify="" placeholder="填写组员“邮箱”" autocomplete="off" class="layui-input" value="" oninput="write_email(this)">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">群组职称</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="title[]" lay-verify="" placeholder="填写组员“职称”" autocomplete="off" class="layui-input" value="">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item" style="margin-top:10px;">
                    <div class="layui-input-block" style="text-align: center;margin-left:0 !important;">
                        <button class="layui-btn" lay-submit="" lay-filter="component-form-demo1">立即组建</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    layui.config({
        base: '/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'form','upload','element'], function() {
        var $ = layui.$
            , admin = layui.admin
            , element = layui.element
            , layer = layui.layer
            , form = layui.form
            , upload = layui.upload;

        form.render(null, 'component-form-group');

        form.on('select(type)',function(data){
            let val = data.value;

            if(val==1){
                $(this).parents(":eq(4)").find('.type1').show();
                $(this).parents(":eq(4)").find('.type2').hide();
            }else if(val==2){
                $(this).parents(":eq(4)").find('.type1').hide();
                $(this).parents(":eq(4)").find('.type2').show();
            }
        });

        /* 监听提交 */
        form.on('submit(component-form-demo1)', function (data) {
            layer.load();
            $.ajax({
                url: "/?s=member/save_group",
                method: 'post',
                data: data.field,
                dataType: 'JSON',
                success: function (res) {
                    layer.closeAll('loading');

                    layer.msg(res.msg, {time: 2000}, function () {
                        if (res.code == 0) {
                            // var index = parent.layer.getFrameIndex(window.name);
                            // parent.layer.close(index);
                            window.location.reload();
                        }
                    });
                },
                error: function (data) {
                    layer.msg('系统错误', {time: 2000});
                }
            });
            return false;
        });

        $(document).click(function(event) {
            var clickOverlay2 = $(event.target).closest('.result_div');
            var clickOverlay3 = $(event.target).closest('#user_id');
            var clickBody = $(event.target).closest('body');

            if (clickOverlay2.length == 0 && clickOverlay3.length == 0 && clickBody.length && !event.target.matches('.result_div')) {
                // 执行指定内容
                $('.result_div').hide();
            }
        });
    });

    function search_user(t){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form;

        $.post('/?s=member/get_name',{'type':3,'val':$(t).val()},function(data){
            if(data.code==0){
                let html = '<ul>';
                for(let i=0;i<data.list.length;i++){
                    html += '<li onclick="select_name(this)" data-name="'+data.list[i].name+'" data-id="'+data.list[i].id+'">'+data.list[i].name+'</li>';
                }
                html += '</ul>';
                $(t).parent().find('.result_div').html(html);
                $(t).parent().find('.result_div').show();
            }else{
                $(t).parent().find('.result_div').html('');
                $(t).parent().find('.result_div').hide();
            }
        });
    }

    function write_email(t){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form;

        $(t).parents(":eq(4)").find('.layui-colla-title').find('.sel_box').text($(t).val());
    }

    function select_name(t){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form;

        let name = $(t).attr('data-name');
        let id = $(t).attr('data-id');
        $(t).parents(":eq(2)").find('.user_name').val(name);
        $(t).parents(":eq(2)").find('.user_id').val(id);
        $(t).parents(":eq(6)").find('.sel').text(name);
        $('.result_div').hide();
    }

    function add_member(t){
        var $ = layui.$
            , layer = layui.layer
            , element = layui.element
            , form = layui.form;

        let html = '<div class="layui-colla-item">\n' +
            '                        <h2 class="layui-colla-title"><div class="disf" style="justify-content: space-between;"><div class="sel_box"><span class="sel">请选择组员</span></div><div><div class="layui-btn layui-btn-danger member_opera" onclick="del_member(this)">-</div><div class="layui-btn layui-btn-parimary member_opera" onclick="add_member(this)">+</div></div></div></h2>\n' +
            '                        <div class="layui-colla-content layui-show">\n' +
            '                            <div class="info_div">\n' +
            '                                <div class="layui-form-item">\n' +
            '                                    <label class="layui-form-label">邀请方式</label>\n' +
            '                                    <div class="layui-input-block">\n' +
            '                                        <select name="type[]" lay-filter="type">\n' +
            '                                            <option value="1">搜索组员“邮箱”或“手机号”</option>\n' +
            '                                            <option value="2">填写组员“邮箱”</option>\n' +
            '                                        </select>\n' +
            '                                    </div>\n' +
            '                                </div>\n' +
            '                                <div class="layui-form-item type1">\n' +
            '                                    <label class="layui-form-label">选择组员</label>\n' +
            '                                    <div class="layui-input-block">\n' +
            '                                        <input type="hidden" name="user_id[]" class="user_id" value="">\n' +
            '                                        <input type="text" name="user_name[]" lay-verify="" placeholder="搜索组员“邮箱”或“手机号”" id="user_id" autocomplete="off" class="layui-input user_name" value="" oninput="search_user(this)">\n' +
            '                                        <div class="result_div"></div>\n' +
            '                                    </div>\n' +
            '                                </div>\n' +
            '                                <div class="layui-form-item type2">\n' +
            '                                    <label class="layui-form-label">填写邮箱</label>\n' +
            '                                    <div class="layui-input-block">\n' +
            '                                        <input type="text" name="email[]" lay-verify="" placeholder="填写组员“邮箱”" autocomplete="off" class="layui-input" value="">\n' +
            '                                    </div>\n' +
            '                                </div>\n' +
            '                                <div class="layui-form-item">\n' +
            '                                    <label class="layui-form-label">群组职称</label>\n' +
            '                                    <div class="layui-input-block">\n' +
            '                                        <input type="text" name="title[]" lay-verify="" placeholder="填写组员“职称”" autocomplete="off" class="layui-input" value="">\n' +
            '                                    </div>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                        </div>\n' +
            '                    </div>';

        $(t).parents(":eq(4)").append(html);
        form.render(null,'component-form-group');
        element.render('collapse');
    }

    function del_member(t){
        var $ = layui.$
            , layer = layui.layer
            , element = layui.element
            , form = layui.form;

        var c = layer.confirm('确认要删除该组员吗？',{
            btn:['删除','取消']
        }, function(){
            $(t).parents(":eq(3)").remove();
            layer.close(c);
        },function(){

        });
    }
</script>
</body>
</html>