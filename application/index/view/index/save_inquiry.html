{include file="common/header"}
<link rel="stylesheet" href="layui/css/layui.css">
<script src="layui/layui.js"></script>
<style type="text/css" media="all">
    #content{padding-top:20px;padding-bottom:20px;background:{$website['color_inner']};}
    .navbar_menu a:last-child{color:#D2A778;font-weight:700;}
    .navbar_menu{margin-bottom:15px;}
    .navbar_menu a{color:{$website['color_word']};font-size:16px;}
    .layui-elem-field legend,.layui-form-item .layui-form-label{color:{$website['color_word']};}
    .layui-card{background:{$website['color_inner']};}
    .content{padding:20px 20px;box-sizing:border-box;}
    .content .col-md-12{padding:0;float:unset;}
    .content .box_content{justify-content:center;border-radius:8px;margin-bottom:30px;}
    .content .box_content{background:{$website['color_inner']};color:{$website['color_word']};border:1px solid {$website['color_word']};font-size:25px;text-align:center;padding:30px;width:100%;}
    .content .box_content img{width:40px;margin-right:5px;}
    
    .layui-form-label{width:100px;}
    .layui-input-block{line-height:38px;}
    legend{width:unset;border-bottom:0;}
    .ordertype2,.type1_h,.type1,.type2,.create_user,.type2_h,.type3,.sms{display:none;}
    /**文件上传**/
    .image_box{}
    .image_box .image_item{}
    .image_box .image_item .remove_image{color:{$website['color_word']};font-size:15px;}
    /**数量增减框样式**/
    .quantity {display: flex;align-items: center;}
    .quantity input[type="number"] {text-align: center;}
    .quantity button {background-color: transparent;cursor: pointer;font-size: 20px;padding: 0 5px;border: 1px solid #e6e6e6;height: 38px;width: 50px;text-align: center;color:{$website['color_word']};}
    .input30{width:30%;}
    /*.input20{width:21.5%;}*/
    @media (max-width: 992px) {
        .input30{width:100%;}
        .input20{width:100%;}
        /*.layui-laydate-range{width: 100%; }*/
        .layui-laydate-range{left: 0 !important;width: fit-content;}
        .layui-laydate-range .layui-laydate-main{display: block;width: 100%;}
        .layui-laydate-range .layui-laydate-main .layui-laydate-content table{width: 100%;}
        .back_div{margin-top:15px;}
    }
</style>
<link rel="stylesheet" href="./css/ajaxupload/font-awesome.min.css?x=123">
<link rel="stylesheet" href="./css/ajaxupload/style.css?x=1111">
<section id="content" class="non_topimg">
    <div class="container">
        <div class="content" style="padding:0;">
            <div class="layui-fluid" style="padding:0;">
                <div class="layui-row layui-col-space15">
                    <form class="layui-form" action="" method="post" lay-filter="component-form-element">
                        <input type="text" name="buss_id" id="buss_id" value="{$buss_id}" style="display:none;"/>
                        <input type="text" name="mid2" id="mid" value="{$mid}" style="display:none;"/>
                        <input type="number" name="type" value="{$type}" style="display: none;">
                        <div class="layui-col-md12 back_div">
                            {if !empty($navbar_menu)}
                                <p class="navbar_menu"><i class="fa fa-sign-in" style="margin-right:5px;color:{$website['color_word']};"></i>{$navbar_menu}</p>
                            {else}
                                <a href="javascript:history.back(-1);">
                                    <div style="display:flex;align-items:center;border: 1px solid #fff;width: fit-content;padding: 10px 20px;border-radius: 15px;background: #8f8b8b;margin-bottom:30px;color:#fff;">
                                        <img class="" src="./img/account/back.png" alt="" style="width: 18px;margin-right: 10px;"/>
                                        返回
                                    </div>
                                </a>
                            {/if}

                            <div class="layui-card">
                                <div class="layui-card-body" style="padding:0;">
                                    <fieldset class="layui-elem-field  template_box">
                                        <legend>[{$buss_pname}]业务询价单</legend>
                                        <div class="layui-field-box">
                                            {if empty($type)}
                                                {volist name="template['content']" key="idx" id="vo"}
                                                    {if ($vo.label_value!=5 && $vo.label_value!='')}
                                                        <div class="layui-form-item">
                                                            <div class="layui-form-label">{$vo.label_name}</div>
                                                            <div class="layui-input-block">
                                                                {if $vo.label_value==1}
                                                                    <input type="text" class="layui-input input30" name="content[]" value="" placeholder="" lay-verify="required"/>
                                                                {elseif($vo.label_value==2)}
                                                                    <input type="number" class="layui-input input30" name="content[]" value="" placeholder="" lay-verify="required"/>
                                                                {elseif($vo.label_value==3)}
                                                                    <input type="text" class="layui-input input30" name="content[]" id="date{$vo.label_rand}" value="" placeholder="yymmddhhii" lay-verify="required">
                                                                {elseif($vo.label_value==4)}
                                                                    <div class="input30">
                                                                        <select name="content[]" lay-search>
                                                                            {volist name="vo.label_select2" id="vo2"}
                                                                            <option value="{$vo2}">{$vo2}</option>
                                                                            {/volist}
                                                                        </select>
                                                                    </div>
                                                                {elseif($vo.label_value==51)}
                                                                    <div class="quantity">
                                                                        <button type="button" onclick="decrementValue(event)">-</button>
                                                                        <input type="number" class="layui-input input20" name="content[]" value="0" oninput="if(value>1000)value=1000;if(value.length>4)value=value.slice(0,4);if(value<0)value=0" />
                                                                        <button type="button" onclick="incrementValue(event)">+</button>
                                                                    </div>
                                                                    {if $vo.label_introduce!=''}
                                                                    <span style="font-size: 12px;color: #888;">{$vo.label_introduce}</span>
                                                                    {/if}
                                                                {elseif($vo.label_value==6)}
                                                                    <input type="text" class="layui-input input30" name="content[]" id="date{$vo.label_rand}" value="" placeholder="yymmddhhii" lay-verify="required">
                                                                {/if}
                                                            </div>
                                                        </div>
                                                    {else}
                                                        <input type="number" class="layui-input" id="label5_{$idx}" name="content[]" value="" style="display:none;" />
                                                    {/if}
                                                {/volist}
                                                {if !empty($label5_select)}
                                                    <div class="label5">
                                                        <div class="layui-form-item">
                                                            <div class="layui-form-label" style="color:#000;padding:0;overflow:visible;">
                                                                <select name="label5_select[]" class="tmp" lay-search lay-filter="tmp" lay-verify="required">
                                                                    <option value="">请选择</option>
                                                                    {volist name="label5_select" key="idx" id="vo2"}
                                                                    <option value="{$vo2.label_name}" data-introduce="{$vo2.label_introduce}">{$vo2.label_name}</option>
                                                                    {/volist}
                                                                </select>
                                                            </div>
                                                            <div class="layui-input-block">
                                                                <div class="disf" style="align-items: baseline;">
                                                                    <div class="layui-col-xs12" style="margin-right:5px;width:fit-content;">
                                                                        <div class="quantity">
                                                                            <button type="button" onclick="decrementValue(event)">-</button>
                                                                            <input type="number" class="layui-input input20" name="label5_content[]" value="0" oninput="if(value>1000)value=1000;if(value.length>4)value=value.slice(0,4);if(value<0)value=0" />
                                                                            <button type="button" onclick="incrementValue(event)">+</button>
                                                                        </div>
                                                                        <span class="label_introduce" style="font-size: 12px;color: {$website['color_word']};"></span>
                                                                    </div>
                                                                    <div class="layui-btn layui-btn-md layui-btn-primary" onclick="add_label5(this)">增加</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {/if}
                                            {/if}
                                            {if !empty($type)}
                                            <div class="layui-form-item">
                                                <label class="layui-form-label">询价信息</label>
                                                <div class="layui-input-block layui-select-fscon">
                                                    <textarea name="text" id="text" class="layui-textarea" placeholder="请输入询价文本信息" lay-verify="required"></textarea>
                                                </div>
                                            </div>
                                            {/if}
                                            <!--提交询价文件-->
                                            <div class="layui-form-item">
                                                <div class="layui-form-label">提交文件</div>
                                                <div class="layui-input-block">
                                                    <div class="uploadbox" style="margin-top:15px;">
                                	                    <div id="image_box" style="margin-bottom:15px;"></div>
                            	                        <div class="fileupload_box">
                                    						<label class="fileupload">
                                    							<div class="pic_show" style="background:{$website['color']};">
                                    								
                                    								<div class="text">
                                    									<i class="icon icon_plus"></i>
                                    									<span class="f12">上传文件</span>
                                    								</div>
                                    								
                                    								<img id="image_file_image" src=""  />
                                    								<input type="button" class="filebox" name="image_file" id="image_file" value="" />	
                                    								<div class="fileuploading"></div>
                                    							</div>
                                    						</label>
                                    					</div>
                                	                </div>
                                                </div>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>
                                <div class="layui-form-item" style="margin-top: 25px;text-align: center;">
                                    <div>
                                        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="component-form-element2">提交询价</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{include file="common/footer"}
<script type="text/javascript" src="./js/ajaxupload/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="./js/ajaxupload/ajaxupload.js"></script>
<script type="text/javascript" src="./js/ajaxupload/edit_deal_item.js"></script>
<script type="text/javascript" src="./js/ajaxupload/juUI.js"></script>
<script type="text/javascript" src="./js/ajaxupload/plupload.full.min.js"></script>
<script type="text/javascript" src="./js/ajaxupload/script.js"></script>
<script type="text/javascript" src="./js/ajaxupload/jquery.bgiframe.js"></script>
<script type="text/javascript" src="./js/ajaxupload/jquery.weebox.js"></script>
<script type="text/javascript" src="./js/ajaxupload/touch.js"></script>
<script type="text/javascript">
    function incrementValue(event) {
        event.preventDefault();
        var input = event.target.parentNode.querySelector('input[type="number"]');
        var newValue = parseInt(input.value) + 1;
        input.value = newValue > parseInt(input.max) ? input.value : newValue;
    }

    function decrementValue(event) {
        event.preventDefault();
        var input = event.target.parentNode.querySelector('input[type="number"]');
        var newValue = parseInt(input.value) - 1;
        if(newValue>=0){
            input.value = newValue < parseInt(input.min) ? input.value : newValue;
        }
    }

    function IsPhone() {
        var info = navigator.userAgent;
        var isPhone = /mobile/i.test(info);
        return isPhone;
    }

    layui.use(['layer','form','laydate','upload'],function(){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form
            , laydate = layui.laydate
            , upload = layui.upload;

        get_file_fun("image_file");
        
        form.render(null, 'component-form-element');

        form.on('select(tmp)',function(data){
            let val = data.value;
            let e = data.elem;
            var introduce = e[e.selectedIndex].dataset.introduce;

            $(this).parent().parent().parent().siblings('.layui-input-block').find('.label_introduce').text(introduce);
        });

        {if !empty($template['content'])}
            {volist name="template['content']" id="vo"}
                {if($vo.label_value==3)}
                    laydate.render({
                        elem: '#date{$vo.label_rand}' //指定元素
                        ,min: "<?php echo date('Y-m-d');?>"
                    });
                {elseif($vo.label_value==6)}
                    laydate.render({
                        elem: '#date{$vo.label_rand}' //指定元素
                        ,range:true
                        ,min: "<?php echo date('Y-m-d');?>"
                        ,max: "<?php echo date('Y-m-d',time()+63072000)?>"
                    });
                    if(IsPhone()) {
                        $("#date{$vo.label_rand}").click(function () {
                            setTimeout(function () {
                                $('.layui-laydate-range').css('width', '100%');
                            }, 500);
                        });
                    }
                {/if}
            {/volist}
        {/if}

        form.on('submit(component-form-element2)', function(data){
            // JSON.stringify()
            // console.log(data.field);return false;
            $.ajax({
                url:"/?s=index/save_inquiry",
                method:'post',
                data:data.field,
                dataType:'JSON',
                success:function(res){
                    layer.msg(res.msg,{time:2000}, function () {
                        if(res.code == 0)
                        {
                            //跳转到感谢使用页
                            window.location.href='/?s=index/thanks';
                        }else if(res.code == -1){
                            layer.open({
                                type: 2,
                                title: '请先登录',
                                shadeClose: true,
                                shade: 0.3,
                                area: ['100%', '100%'],
                                content: "/?s=index/customer_login&open=1&inquiry_id="+res.inquiry_id,
                            });
                        }else if(res.code==-2){

                        }
                    });
                },
                error:function (data) {
                    layer.msg('系统错误',{time:2000});
                }
            });
            return false;
        });
    });

    function add_label5(t){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form;
        let tmp_length = $('.tmp').length;
        let tmp_val = $(t).parent().parent().parent().parent().find('.tmp').length;
        let tmp = $(t).parent().parent().parent().parent().find('.tmp');
        let select_arr = [];
        for(let i=0;i<tmp_val;i++){
            select_arr.push(tmp.eq(i).find('option:selected').val());
            if(tmp.eq(i).find('option:selected').val()==''){
                layer.msg('新增内容不能为空');return false;
            }
        }
        if(tmp_val+1 > tmp.eq(0).find('option').length-1){
            layer.msg('无可选数据增加');
            return false;
        }
        let tmp_option = $(t).parent().parent().siblings('.layui-form-label').find('.tmp').find('option').length;
        <?php $select_idx = -1;?>
        let html = '<div class="layui-form-item">\n' +
            '                                                            <div class="layui-form-label" style="color:#000;padding:0;overflow:visible;">\n' +
            '                                                                <select name="label5_select['+tmp_length+']" id="tmp" class="tmp" lay-search lay-filter="tmp" lay-verify="required">\n'+
            '                                                                   <option value="">请选择</option>';
                                                                                {volist name="label5_select" key="idx" id="vo2"}
                                                                                if(select_arr.indexOf("{$vo2.label_name}") > -1){
                                                                                    html += '<option value="{$vo2.label_name}" disabled>{$vo2.label_name}</option>\n';
                                                                                }else{
                                                                                    html += '<option value="{$vo2.label_name}" data-introduce="{$vo2.label_introduce}">{$vo2.label_name}</option>\n';
                                                                                }
                                                                                {/volist}

            html += '                                                        </select>\n' +
            '                                                            </div>\n' +
            '                                                            <div class="layui-input-block">\n' +
            '                                                                <div class="disf" style="align-items: baseline;">\n' +
            '                                                                    <div class="layui-col-xs12" style="margin-right:5px;">\n' +
            '                                                                        <div class="quantity">\n' +
            '                                                                            <button type="button" onclick="decrementValue(event)">-</button>\n' +
            '                                                                            <input type="number" class="layui-input input20" name="label5_content['+tmp_length+']" value="0" oninput="if(value>1000)value=1000;if(value.length>4)value=value.slice(0,4);if(value<0)value=0" />\n' +
            '                                                                            <button type="button" onclick="incrementValue(event)">+</button>\n' +
            '                                                                        </div>\n';
            {volist name="label5_select" key="idx" id="vo2"}
                // if(select_arr.indexOf("$vo2.label_name") == -1){
                    if(<?php echo $select_idx;?> == -1)
                    {
                        <?php $select_idx = 123;?>
                        html += '                                                    <span class="label_introduce" style="font-size: 12px;color: {$website[\'color_word\']};"></span>\n';
                    }
                // }
            {/volist}
            html += '                                                                    </div>\n' +
            '                                                                    <div class="layui-btn layui-btn-md layui-btn-primary" onclick="add_label5(this)">增加</div>\n' +
            '                                                                </div>\n' +
            '                                                            </div>\n' +
            '                                                        </div>';
        //将当前的标签名固定，其它列为disabled
        let val_selected = $(t).parent().parent().siblings('.layui-form-label').find('.tmp').find('option:selected').val();
        let val_options = $(t).parent().parent().siblings('.layui-form-label').find('.tmp').find('option');
        for(let k=0;k<val_options.length;k++){
            if(val_selected!=val_options.eq(k).val()){
                $(t).parent().parent().siblings('.layui-form-label').find('.tmp').find('option').eq(k).attr('disabled','disabled');
            }
        }
        $(t).remove();
        $('.label5').append(html);
        form.render(null, 'component-form-element');
    }

    var MAX_FILE_SIZE = "3MB";
    var UPLOAD_URL ='?s=index/upload_file';
	var UPLOAD_SWF='./js/ajaxupload/Moxie.swf';
	var UPLOAD_XAP='./js/ajaxupload/Moxie.xap';
	var ALLOW_IMAGE_EXT= "gif,jpg,jpeg,png,bmp,xls,excel,xlsx,word,pdf";
	var MAX_IMAGE_SIZE= "3MB";
	function get_file_fun(name){
		$("#"+name).ui_upload({
		    multi:true,
			FileUploaded:function(ajaxobj){
			    let name = $("#image_box .image_item").length+1;
				if($("#image_box .image_item").length>=100) {
					alert("最多只能上传100个文件");
				}
 				else if(ajaxobj.error==0) {
					alert(ajaxobj.message);
				}
				else {
					$("#image_box").append(
		   				'<div class="image_item" style="display: inline-block;margin-right: 15px;width:90px;text-align:center;margin-bottom:15px;">'+
							'<div class="remove_image" style="color:{$website["color_word"]};font-size:15px;"><i class="fa fa-remove"></i></div>'+
							'<img src=".'+ajaxobj.file_path+'" width=90 height=90 class="b_radius6" onerror=src="https://shop.gogo198.cn/attachment/images/default_file.png" />'+
							'<input type="hidden" name="file[]" class="files" value="'+ajaxobj.file_path+'"  />'+
							'<input type="text" name="filename[]" class="filenames" value="文件'+name+'" placeholder="填写文件名称" style="width:100%;height:30px;border: 1px solid #D2A778;">'+
						'</div>'
					);
		   			bind_del_image(); // 删除已上传的图片
		   			if($("#image_box .image_item").length>=100) {
		   			    hide_imgupload(); // 上传5张图片后，隐藏上传图片按钮
		   			}
 				}
			},Error:function(error) {
				alert(error.message);
	 		}
	 	});
	}
</script>
