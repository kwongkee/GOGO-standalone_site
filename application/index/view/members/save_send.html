{include file="common/new_member_header"}
<style type="text/css">
    .layui-upload-img{width: 92px; height: 92px; margin: 0 10px 10px 0;}
    .layui-btn{background-color: #F7931E !important;}
    .layui-btn-primary{background-color: #fff !important;}
    .layui-btn-primary:hover {border-color: #F7931E !important;}
    .layui-fluid{padding:0;}
    .info_div{display: grid;grid-template-columns: repeat(2,1fr);-moz-column-gap: 0px;column-gap: 0px;row-gap: 0px;padding:10px;box-sizing: border-box;}
    .layui-table th{background: {$website['color']};color:{$website['color_word']};}
    @media screen and (min-width: 992px){
        .layui-form-label {margin-left: 10px!important;}
        .layui-input-block{margin-left: 140px !important;}
        .yulan{width: 700px !important;}
        .layui-select-fs{width: 100%;}
        .layui-select-fscon{width: 735px !important;}
    }
    @media screen and (max-width: 450px){
        .layui-form-label {width: 60px!important;margin-left: 0px!important;}
        .layui-input-block{margin-left: 80px !important;}
        .layui-form-label{padding: 9px 5px;}
        .yulan{width: 72% !important;}
        .layui-select-fs{width: 100%;}
        .layui-select-fscon{width: 62%  !important;}
        .layui-form-item .layui-input-inline {display: block;float: none;left: 4px;width: auto;margin: 0 0 10px 95px;}
        .layui-form-item .layui-inline {margin-bottom:10px;}
        .layui-form-item{margin-bottom:10 !important;}
        .info_div{display: grid;grid-template-columns: repeat(1,1fr);-moz-column-gap: 0px;column-gap: 0px;row-gap: 0px;}
    }
    html{background:#fff;}
    .layui-btn{background:{$website['color']} !important;}
    .layui-btn-danger{background:#e60000 !important;}
    .layui-btn-primary{background:#fff !important;}
    .sel_div .layui-form-selected dl{width: 100%;}


    /**添加地址**/
    .countryBox{display:inline-block;margin-left:5px;}
    .countryBox:first-child{margin-left:0;}
    .countryDiv{width:100px;}
    .sort_div select{display:none !important;}
    .sort_div,.addr{display: grid;grid-template-columns: repeat(1,1fr);-moz-column-gap: 0px;column-gap: 0px;row-gap: 0px;}
    .postal_temp{border:1px solid #000;width: 48px;height: 38px;text-align: center;line-height: 38px;margin-right:2px;}
    .postal_code{margin-right:2px;}
    .addr{width:100%;}
    .hide2{display: none;}
    .sort_div, .addr{padding:10px;box-sizing: border-box;}
    .sort_div{padding-bottom: 0;}
    .addr{padding-top: 0;}
    .postal_rule2{width:200px;}
    .postal_code{width:50px;}
    .diycountry{padding:2px 5px;box-sizing:border-box;}
    @media (max-width: 992px){
        .sort_div, .addr{grid-template-columns: repeat(1,1fr);}
        .postal_rule2{width:100px;}
        .postal_temp{border:1px solid #000;width: 24px;height: 24px;text-align: center;line-height: 24px;margin-right:0px;}
        .postal_code{width:26px;height:24px;line-height: 24px;margin-right:0;padding:0;text-align:center;}
        .countryDiv {width: 80px;}
        .diycountry{padding:0;box-sizing:border-box;}
        .countryDiv:nth-child(odd){margin-left:0;}
    }
    .layui-form-label,.layui-input-block{font-size:15px;}
    .upd_txt{line-height: 38px;}
</style>
<script src="/centralize_manager/js/jquery.min.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script src="/layuiadmin/qrcode/jquery-3.2.1.min.js"></script>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body" style="padding: 0px;">
            <form class="layui-form" action="" lay-filter="component-form-group">
                <input type="hidden" name="pa" value="1">
                <div class="sort_div">
                    <div class="layui-form-item">
                        <label class="layui-form-label">国地</label>
                        <div class="layui-input-block">
                            {if($id>0)}
                            <p class="upd_txt">{$address['detail_area']}</p>
                            {else}
                            <div class="countryDiv countryBox">
                                <select name="country" id="country" lay-verify="required" lay-search lay-filter="country">
                                    <option value="">请选择国地</option>
                                    {volist name="country" key="k" id="v"}
                                    <option value="{$v['id']}">{$v['param2']}</option>
                                    {/volist}
                                </select>
                            </div>
                            <div class="countryDiv countryBox province" style="display: none;"></div>
                            <div class="countryDiv countryBox city" style="display: none;"></div>
                            <div class="countryDiv countryBox area" style="display: none;"></div>
                            <div class="countryDiv countryBox area2" style="display: none;"></div>
                            <div class="countryDiv countryBox area3" style="display: none;"></div>
                            <div class="countryDiv countryBox area4" style="display: none;"></div>
                            <div class="diycountry" style="display:none;">
                                <input class="layui-input countryDiv countryBox" name="diycountry[]" placeholder="请输入行政区域">

                                <div class="layui-btn layui-btn-success add" onclick="add_diycountry(this)" style="display:inline-block;">+</div>
                            </div>
                            {/if}
                        </div>
                    </div>
                </div>
                <div class="info_div">
                    <div class="layui-form-item">
                        <label class="layui-form-label">收货名称</label>
                        <div class="layui-input-block disf">
                            <input type="text" class="layui-input" lay-verify="required" name="user_name1" id="user_name1" value="{$address['user_name'][0]}" placeholder="名">
                            <input type="text" class="layui-input" lay-verify="" name="user_name2" id="user_name2" value="{$address['user_name'][1]}" placeholder="中间名">
                            <input type="text" class="layui-input" lay-verify="required" name="user_name3" id="user_name3" value="{$address['user_name'][2]}" placeholder="姓">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">联系电话</label>
                        <div class="layui-input-block disf">
                            <input type="text" name="area_mobile" id="area_mobile" lay-verify="required" placeholder="区号" autocomplete="off" class="layui-input" value="{$address['area_mobile']}" style="width:50px;" readonly>
                            <input type="text" name="mobile" lay-verify="required" placeholder="联系电话" autocomplete="off" class="layui-input" value="{$address['mobile']}">
                            <input type="text" name="mobile2" lay-verify="" placeholder="联系电话2" autocomplete="off" class="layui-input" value="{$address['mobile2']}">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-form-label">邮政编码</div>
                        <div class="layui-input-block postal_div">
                            {if($id>0)}
                            <p class="upd_txt">{$address['postal_code']}</p>
                            {else}
                            <div class="disf">
                                <div style="width:50px;">例子：</div>
                                <div class="postal_rule disf"></div>
                            </div>
                            <div class="disf">
                                <div style="width:50px;">填写：</div>
                                <div class="postal_rule2 disf"></div>
                            </div>
                            {/if}
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-form-label">电子邮箱</div>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input" lay-verify="" name="email" id="email" value="{$address['email']}" placeholder="电子邮箱">
                        </div>
                    </div>

                    <input type="hidden" id="address_num" value="<?php echo 1+count($address['address2']);?>">

                    <div class="layui-form-item">
                        <div class="layui-form-label">详细地址</div>
                        <div class="layui-input-block disf">
                            <input type="text" class="layui-input" lay-verify="required" name="address1" value="{$address['address1']}" placeholder="详细地址">
                            <div class="layui-btn layui-btn-success add" onclick="add_address()">+</div>
                        </div>
                    </div>
                </div>
                <div class="addr">
                    {if(!empty($address['address2']))}
                    {volist name="address['address2']" key='k' id="v"}
                    <div class="layui-form-item">
                        <div class="layui-form-label">地址<?php echo $k+1;?></div>
                        <div class="layui-input-block disf">
                            <input type="text" class="layui-input" lay-verify="required" name="address2[]" value="{$v}" placeholder="请输入地址">
                            <div class="layui-btn layui-btn-success add" onclick="add_address()">+</div>
                            <div class="layui-btn layui-btn-danger del" onclick="del_address(this)">-</div>
                        </div>
                    </div>
                    {/volist}
                    {/if}
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block disf" style="justify-content: center;margin-left:0 !important;">
                        <div style="margin-right:10px;">
                            <input type="checkbox" name="is_default" id="is_default" lay-skin="primary" title="默认" value="{$address['is_default']}" {if($address['is_default']==1)}checked{/if}  onclick="is_defaults(this)"  style="display:none;">
                        </div>
                        <button class="layui-btn" lay-submit="" lay-filter="component-form-demo1">立即保存</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    layui.config({
        base: '/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'form','upload'], function() {
        var $ = layui.$
            , admin = layui.admin
            , element = layui.element
            , layer = layui.layer
            , form = layui.form
            , dropdown = layui.dropdown
            , upload = layui.upload;

        form.render(null, 'component-form-group');

        form.on('select(country)',function(data){
            let val = data.value;
            //获取区号+邮编+一级行政区域
            $.getJSON('/?s=members/getphonenum',{'id':val,'pa':1},function(res2){
                $('#area_mobile').val(res2.phone);

                //邮编
                var regNumber = /\d+/;
                var regString = /[a-zA-Z]+/;
                let html = '';
                let html2 = '';
                for(let i=0;i<res2.post.length;i++){
                    if(regNumber.test(res2.post[i]) || regString.test(res2.post[i])) {
                        html += '<div class="postal_temp">'+res2.post[i]+'</div>';
                        html2 += '<input type="text" name="postal_code[]" lay-verify="required" placeholder="" autocomplete="off" class="layui-input postal_code" value="" maxlength="1">';
                    }else{
                        html += '<div class="postal_temp" style="font-size:18px;font-weight:800;">'+res2.post[i]+'</div>';
                        html2 += '<input type="text" name="postal_code[]" lay-verify="" placeholder="" autocomplete="off" class="layui-input postal_code" value="'+res2.post[i]+'" maxlength="1">';
                    }
                }
                $('.postal_rule').html(html);
                $('.postal_rule2').html(html2);
                $('.postal_div').show();

                //省
                let html3 = '<select name="province" lay-search lay-filter="province">'+
                    ' <option value="">请选择</option>'+
                    ' <option value="自定义">自定义</option>';
                for(let i=0;i<res2.province.length;i++){
                    html3 += '<option value="'+res2.province[i].id+'">'+res2.province[i].code_name+'</option>';
                }
                html3 += '</select>';
                $('.sort_div').find('.province').show();
                $('.sort_div').find('.province').html(html3);

                form.render(null,'component-form-group');
            });
        });
        form.on('select(province)',function(data){
            let val = data.value;
            if(val=='自定义'){
                $('.sort_div').find('.diycountry').show();
                $('.sort_div').find('.province').hide();
                $('.sort_div').find('.city').hide();
                $('.sort_div').find('.area').hide();
                $('.sort_div').find('.area2').hide();
                $('.sort_div').find('.area3').hide();
                $('.sort_div').find('.area4').hide();
                //   $('.sort_div').find('.area').hide();
            }else if(val!=''){
                $.getJSON('/?s=members/getphonenum',{'id':val,'pa':2},function(res2){
                    let html = '<select name="city" lay-search lay-filter="city">'+
                        ' <option value="">请选择</option>'+
                        ' <option value="自定义">自定义</option>';
                    for(let i=0;i<res2.area.length;i++){
                        html += '<option value="'+res2.area[i].id+'">'+res2.area[i].code_name+'</option>';
                    }
                    html += '</select>';
                    $('.sort_div').find('.city').html(html);
                    $('.sort_div').find('.city').show();
                    $('.diycountry').hide();
                    form.render(null,'component-form-group');
                });
            }
        });
        form.on('select(city)',function(data){
            let val = data.value;
            if(val=='自定义'){
                $('.sort_div').find('.diycountry').show();
                // $('.sort_div').find('.province').hide();
                $('.sort_div').find('.city').hide();
                $('.sort_div').find('.area').hide();
                $('.sort_div').find('.area2').hide();
                $('.sort_div').find('.area3').hide();
                $('.sort_div').find('.area4').hide();
                //   $('.sort_div').find('.area').hide();
            }else if(val!=''){
                $.getJSON('/?s=members/getphonenum',{'id':val,'pa':2},function(res2){
                    let html = '<select name="area" lay-search lay-filter="area">'+
                        ' <option value="">请选择</option>'+
                        ' <option value="自定义">自定义</option>';
                    for(let i=0;i<res2.area.length;i++){
                        html += '<option value="'+res2.area[i].id+'">'+res2.area[i].code_name+'</option>';
                    }
                    html += '</select>';
                    $('.sort_div').find('.area').html(html);
                    $('.sort_div').find('.area').show();
                    $('.diycountry').hide();
                    form.render(null,'component-form-group');
                });
            }
        });
        form.on('select(area)',function(data){
            let val = data.value;
            if(val=='自定义'){
                $('.sort_div').find('.diycountry').show();
                // $('.sort_div').find('.province').hide();
                // $('.sort_div').find('.city').hide();
                $('.sort_div').find('.area').hide();
                $('.sort_div').find('.area2').hide();
                $('.sort_div').find('.area3').hide();
                $('.sort_div').find('.area4').hide();
            }else if(val!=''){
                $.getJSON('/?s=members/getphonenum',{'id':val,'pa':2},function(res2){
                    let html = '<select name="area2" lay-search lay-filter="area2">'+
                        ' <option value="">请选择</option>'+
                        ' <option value="自定义">自定义</option>';
                    for(let i=0;i<res2.area.length;i++){
                        html += '<option value="'+res2.area[i].id+'">'+res2.area[i].code_name+'</option>';
                    }
                    html += '</select>';
                    $('.sort_div').find('.area2').append(html);
                    $('.sort_div').find('.area2').show();
                    $('.diycountry').hide();
                    form.render(null,'component-form-group');
                });
            }
        });
        form.on('select(area2)',function(data){
            let val = data.value;
            if(val=='自定义'){
                $('.sort_div').find('.diycountry').show();
                // $('.sort_div').find('.province').hide();
                // $('.sort_div').find('.city').hide();
                // $('.sort_div').find('.area').hide();
                $('.sort_div').find('.area2').hide();
                $('.sort_div').find('.area3').hide();
                $('.sort_div').find('.area4').hide();
            }else if(val!=''){
                $.getJSON('/?s=members/getphonenum',{'id':val,'pa':2},function(res2){
                    let html = '<div class="countryDiv countryBox"><select name="area3" lay-search lay-filter="area3">'+
                        ' <option value="">请选择</option>'+
                        ' <option value="自定义">自定义</option>';
                    for(let i=0;i<res2.area.length;i++){
                        html += '<option value="'+res2.area[i].id+'">'+res2.area[i].code_name+'</option>';
                    }
                    html += '</select></div>';
                    $('.sort_div').find('.area3').html(html);
                    $('.sort_div').find('.area3').show();
                    $('.diycountry').hide();
                    form.render(null,'component-form-group');
                });
            }
        });
        form.on('select(area3)',function(data){
            let val = data.value;
            if(val=='自定义'){
                $('.sort_div').find('.diycountry').show();
                $('.sort_div').find('.area3').hide();
                $('.sort_div').find('.area4').hide();
            }else if(val!=''){
                $.getJSON('/?s=members/getphonenum',{'id':val,'pa':2},function(res2){
                    let html = '<select name="area4" lay-search lay-filter="area4">'+
                        ' <option value="">请选择</option>'+
                        ' <option value="自定义">自定义</option>';
                    for(let i=0;i<res2.area.length;i++){
                        html += '<option value="'+res2.area[i].id+'">'+res2.area[i].code_name+'</option>';
                    }
                    html += '</select>';
                    $('.sort_div').find('.area4').html(html);
                    $('.sort_div').find('.area4').show();
                    $('.diycountry').hide();
                    form.render(null,'component-form-group');
                });
            }
        });
        form.on('select(area4)',function(data){
            let val = data.value;
            if(val=='自定义'){
                $('.sort_div').find('.diycountry').show();
                $('.sort_div').find('.area4').hide();
            }
        });

        //地址提交
        form.on('submit(component-form-demo1)',function(data){
            data.field['is_default'] = $('#is_default').val();

            $.ajax({
                url: "/?s=members/save_send",
                method: 'post',
                data: data.field,
                dataType: 'JSON',
                success: function (res) {
                    layer.msg(res.msg,{time:2000}, function () {
                        if (res.code == 0) {
                            parent.location.reload();
                        }
                    });
                }
            });
            return false;
        });
    });

    function add_addr(){
        var $ = layui.$
            , layer = layui.layer;

        let area = ['800px','500px'];
        if(IsPhone()){
            area = ['100%','100%'];
        }

        layer.open({
            type: 1,
            title:'添加地址',
            area: area,
            content: $('.address_div')
        });
    }

    function add_address(){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form;
        let address_num = $('#address_num').val();
        address_num = parseInt(address_num) + 1;
        $('#address_num').val(address_num);
        let html = '<div class="layui-form-item">\n' +
            '                    <div class="layui-form-label">地址'+address_num+'</div>\n' +
            '                    <div class="layui-input-block disf">\n' +
            '                        <input type="text" class="layui-input" lay-verify="required" name="address2[]" value="" placeholder="请输入地址">\n' +
            '                        <div class="layui-btn layui-btn-success add" onclick="add_address()">+</div>\n' +
            '                        <div class="layui-btn layui-btn-danger del" onclick="del_address(this)">-</div>\n' +
            '                    </div>\n' +
            '                </div>';

        $('.addr').append(html);
        form.render(null, 'component-form-group');
    }

    function del_address(t){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form;
        let adr_idx = layer.confirm('确认要删除该地址吗？',function(index){
            let address_num = $('#address_num').val();
            address_num = parseInt(address_num) - 1;
            $('#address_num').val(address_num);
            $(t).parent().parent().remove();
            form.render(null, 'component-form-group');
            layer.close(adr_idx);
        });
    }

    function is_defaults(t){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form;

        if($(t).val()==1){
            $(t).val("0");
        }else{
            $(t).val("1");
        }
        form.render(null, 'component-form-group');
    }

    function add_diycountry(t){
        var $ = layui.$
            , layer = layui.layer
            , form = layui.form;

        let html = '<input class="layui-input countryDiv countryBox" name="diycountry[]" placeholder="请输入行政区域" style="">';
        $(t).before(html);
    }

    function select_addrr(t){
        var $ = layui.$
            , form = layui.form
            , layer = layui.layer;

        let val = $(t).val();
        if(val==1){
            $('.country-select').show();
        }else if(val==2){
            $('.country-select').hide();
            add_addr();
        }else if(val==''){
            $('.country-select').hide();
        }
    }
</script>
</body>
</html>